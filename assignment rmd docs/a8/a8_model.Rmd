---
title: "Assignment 8"
author: "Chris Dsida and Reuven Herzog"
date: "3/28/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Required Packages

This first chunk re installs the scenaRios package. You only need to run it once.

```{r}
# library(devtools)
# 
# install_github("https://github.com/c-voulgaris/scenRios")
```

Load all the packages needed:

```{r}
library(here)
library(tidyverse)
library(sf)
library(survey)
library(srvyr)
library(od)
library(ggspatial)
library(scenRios)
```

# Existing conditions

This first section will fit a trip distribution model to our data for the existing conditions.

## Loading and Manipulating Data

```{r}
zones <- here("existing",
              "data",
              "zone_data.csv") %>%
  read_csv(show_col_types = FALSE)

skims <- here("existing",
              "data",
              "all_skims_ex.csv") %>%
  read_csv(show_col_types = FALSE)
```

NHTS trip survey data is already filtered for Austin MSA:

```{r}
austin_trips <- read_csv(here(
                        "assignment rmd docs",
                        "a7",
                        "austin_trips.csv"))
```

Adding trip purposes and grouping by type:

```{r}
trips <- austin_trips %>%
  mutate(home_based = case_when(WHYTO == "01" ~ TRUE,
                                WHYTO == "02" ~ TRUE,
                                WHYFROM == "01" ~ TRUE,
                                WHYFROM == "02" ~ TRUE,
                                TRUE ~ FALSE)) %>%
  mutate(work = ifelse(WHYTO == "03" | WHYFROM == "03", TRUE, FALSE)) %>%
  mutate(purpose = case_when(home_based & work ~ "HBW",
                            home_based ~ "HBO",
                            TRUE ~ "NHB"))
```

## Summarize Average Trip Time by Purpose

Create a survey object:

```{r}
trips_svy <- trips %>%
  as_survey(weights = WTTRDFIN)

ttime_by_purpose <- trips_svy %>%
  group_by(purpose) %>%
  summarise(avg_time = survey_mean(TRVLCMIN))

ttime_by_purpose
```

## Calculate Minimum Travel Times

Finding the minimum travel time across all modes and adding it to the skims:

```{r}
skims <- skims %>%
  mutate(min_time = pmin(transit_time, 
                         car_time,
                         bike_time,
                         walk_time,
                         na.rm = TRUE))
```

## Friction Factors

A starting point for the friction factors. Gamma function performs well.

```{r}
# Using Gamma Function; tweaks to match average times

skims <- skims %>%
  mutate(F_HBW = min_time^-0.106*exp(-0.035*min_time),
         F_HBO = min_time^-3.693*exp(-0.015*min_time),
         F_NHB = min_time^-3.215*exp(-0.002*min_time))
```

```{r}
# Using power function

# skims <- skims %>%
#   mutate(F_HBW = min_time^-2,
#          F_HBO = min_time^-2,
#          F_NHB = min_time^-2)
```

```{r}
# Using exp. function

# m_HBO <- ttime_by_purpose$avg_time[ttime_by_purpose$purpose == "HBO"]
# m_HBW <- ttime_by_purpose$avg_time[ttime_by_purpose$purpose == "HBW"]
# m_NHB <- ttime_by_purpose$avg_time[ttime_by_purpose$purpose == "NHB"]
# 
# skims <- skims %>%
#   mutate(F_HBO = exp(-1 * m_HBO * min_time),
#          F_HBW = exp(-1 * m_HBW * min_time),
#          F_NHB = exp(-1 * m_NHB * min_time)) 
```

## Estimate Travel Flows

Home-based other:

```{r}
HBO_dist <- grvty_balancing(od_zones = zones,
                            friction = skims,
                            zone_id = "GEOID",
                            zone_o = "hbo_prod",
                            zone_d = "hbo_attr_bal",
                            friction_o_id = "fromId",
                            friction_d_id = "toId",
                            friction_factor = "F_HBO",
                            tolerance = 5,
                            max_iter = 500)
```

Home-based work:

```{r}
HBW_dist <- grvty_balancing(od_zones = zones,
                            friction = skims,
                            zone_id = "GEOID",
                            zone_o = "hbw_prod",
                            zone_d = "hbw_attr_bal",
                            friction_o_id = "fromId",
                            friction_d_id = "toId",
                            friction_factor = "F_HBW",
                            tolerance = 5,
                            max_iter = 500)
```

Non-home based:

```{r}
NHB_dist <- grvty_balancing(od_zones = zones,
                            friction = skims,
                            zone_id = "GEOID",
                            zone_o = "nhb_prod",
                            zone_d = "nhb_attr_bal",
                            friction_o_id = "fromId",
                            friction_d_id = "toId",
                            friction_factor = "F_NHB",
                            tolerance = 5,
                            max_iter = 500)
```

For some reason, the balancing never seems to get to the tolerance, no matter how many iterations or which friction factors are used.

This plot was used to observe the convergence (or lack thereof).

```{r}
convergence_points <- NHB_dist$convergence %>%
  mutate(max_diff = max_o_diff + max_d_diff) %>%
  mutate(which_max = ifelse(max_o_diff > max_d_diff,
                            "Productions",
                            "Attractions"))

ggplot(filter(convergence_points, between(iteration, 0, 50))) +
  geom_line(aes(x = iteration, y = max_diff, lty = which_max)) +
  scale_y_continuous(name = "Maximum difference from target value",
                     trans = "log",
                     breaks = breaks <- 10^seq(1,5, by= 1),
                     labels = formatC(breaks,
                                      big.mark = ",",
                                      format = "f",
                                      digits = 0)) +
  scale_x_continuous(name = "Iteration",
                     breaks = breaks <- seq(0, 50, by=10),
                     labels = formatC(breaks,
                                      big.mark = ",",
                                      format = "f",
                                      digits = 0)) +
  annotate(geom = "text", x = 53, y = 407, label = "(407)", size = 3.5) +
  annotate(geom = "text", x = 53, y = 91, label = "(91)", size = 3.5) +
  scale_linetype(name = "") +
  theme_minimal()
```

Appending the various modeled trip flows to our skim table in the existing conditions.

```{r}
HBW_flows <- HBW_dist$flows %>%
  rename(fromId = o_id,
         toId = d_id,
         HBW_flow = flow)

HBO_flows <- HBO_dist$flows %>%
  rename(fromId = o_id,
         toId = d_id,
         HBO_flow = flow)

NHB_flows <- NHB_dist$flows %>%
  rename(fromId = o_id,
         toId = d_id,
         NHB_flow = flow)

skims <- skims %>%
  left_join(HBW_flows) %>%
  replace_na(list(HBW_flow = 0)) %>%
  left_join(HBO_flows) %>%
  replace_na(list(HBO_flow = 0)) %>%
  left_join(NHB_flows) %>%
  replace_na(list(NHB_flow = 0)) %>%
  mutate(total_hbw_time = HBW_flow * min_time,
         total_hbo_time = HBO_flow * min_time,
         total_nhb_time = NHB_flow * min_time)
```

Save the skim with travel flows to our repo.

```{r}
# write_csv(skims, here("existing",
#                       "data",
#                       "all_skims_ex.csv"))
```

This chunk used to confirm alignment with travel survey information.

```{r}
# HBW_mean_time <- sum(skims$total_hbw_time) / sum(skims$HBW_flow)
# HBO_mean_time <- sum(skims$total_hbo_time) / sum(skims$HBO_flow)
# NHB_mean_time <- sum(skims$total_nhb_time) / sum(skims$NHB_flow)
# 
# HBW_mean_time
# HBO_mean_time
# NHB_mean_time
```

# Alternative

## Importing our data

```{r}
zones_alt <- here("alternative",
                  "data",
                  "zone_data.csv") %>%
  read_csv(show_col_types = FALSE)

skims_alt <- here("alternative",
                  "data",
                  "all_skims_alt.csv") %>%
  read_csv(show_col_types = FALSE)
```

## Calculate Minimum Travel Times

Finding the minimum travel time across all modes and adding it to the skims for the alternative scenario:

```{r}
skims_alt <- skims_alt %>%
  mutate(min_time = pmin(transit_time, 
                         car_time,
                         bike_time,
                         walk_time,
                         na.rm = TRUE))
```

## Friction Factors

Using the same factors that were calibrated in the model, just including them in the alternative skim table now.

```{r}
# Using Gamma Function; tweaks to match average times

skims_alt <- skims_alt %>%
  mutate(F_HBW = min_time^-0.106*exp(-0.035*min_time),
         F_HBO = min_time^-3.693*exp(-0.015*min_time),
         F_NHB = min_time^-3.215*exp(-0.002*min_time))
```

## Estimate Travel Flows

Home-based other:

```{r}
HBO_dist_alt <- grvty_balancing(od_zones = zones_alt,
                            friction = skims_alt,
                            zone_id = "GEOID",
                            zone_o = "hbo_prod",
                            zone_d = "hbo_attr_bal",
                            friction_o_id = "fromId",
                            friction_d_id = "toId",
                            friction_factor = "F_HBO",
                            tolerance = 5,
                            max_iter = 500)
```

Home-based work:

```{r}
HBW_dist_alt <- grvty_balancing(od_zones = zones_alt,
                            friction = skims_alt,
                            zone_id = "GEOID",
                            zone_o = "hbw_prod",
                            zone_d = "hbw_attr_bal",
                            friction_o_id = "fromId",
                            friction_d_id = "toId",
                            friction_factor = "F_HBW",
                            tolerance = 5,
                            max_iter = 500)
```

Non-home based:

```{r}
NHB_dist_alt <- grvty_balancing(od_zones = zones_alt,
                            friction = skims_alt,
                            zone_id = "GEOID",
                            zone_o = "nhb_prod",
                            zone_d = "nhb_attr_bal",
                            friction_o_id = "fromId",
                            friction_d_id = "toId",
                            friction_factor = "F_NHB",
                            tolerance = 5,
                            max_iter = 500)
```

Append the flows and travel time to the alternative skim data.

```{r}
HBW_flows_alt <- HBW_dist_alt$flows %>%
  rename(fromId = o_id,
         toId = d_id,
         HBW_flow_alt = flow)

HBO_flows_alt <- HBO_dist_alt$flows %>%
  rename(fromId = o_id,
         toId = d_id,
         HBO_flow_alt = flow)

NHB_flows_alt <- NHB_dist_alt$flows %>%
  rename(fromId = o_id,
         toId = d_id,
         NHB_flow_alt = flow)

skims_alt <- skims_alt %>%
  left_join(HBW_flows_alt) %>%
  replace_na(list(HBW_flow_alt = 0)) %>%
  left_join(HBO_flows_alt) %>%
  replace_na(list(HBO_flow_alt = 0)) %>%
  left_join(NHB_flows_alt) %>%
  replace_na(list(NHB_flow_alt = 0)) %>%
  mutate(total_hbw_time_alt = HBW_flow_alt * min_time,
         total_hbo_time_alt = HBO_flow_alt * min_time,
         total_nhb_time_alt = NHB_flow_alt * min_time)
```

Adding flows from the existing conditions for the sake of comparison. Predicted absolute and percentage changes are calculated for each trip type.

```{r}
skims_ex <- skims %>%
  select(fromId, 
         toId,
         HBW_flow,
         HBO_flow,
         NHB_flow,
         total_hbw_time,
         total_hbo_time,
         total_nhb_time)

skims_alt <- skims_alt %>%
  left_join(skims_ex) 

skims_alt <- skims_alt %>%
  mutate(HBW_flow_ch = HBW_flow_alt-HBW_flow,
         HBO_flow_ch = HBO_flow_alt-HBO_flow,
         NHB_flow_ch = NHB_flow_alt-NHB_flow,
         HBW_flow_pct = HBW_flow_ch/HBW_flow,
         HBO_flow_pct = HBO_flow_ch/HBO_flow,
         NHB_flow_pct = NHB_flow_ch/NHB_flow)
```

Saving the alt skims to our repo.

```{r}
# write_csv(skims_alt, here("alternative",
#                           "data",
#                           "all_skims_alt.csv"))
```

This is for comparison of average trip time by type; all are slightly (>1 minute) longer than in the existing conditions.

```{r}
# HBW_mean_time_alt <- sum(skims_alt$total_hbw_time_alt) / sum(skims_alt$HBW_flow_alt)
# HBO_mean_time_alt <- sum(skims_alt$total_hbo_time_alt) / sum(skims_alt$HBO_flow_alt)
# NHB_mean_time_alt <- sum(skims_alt$total_nhb_time_alt) / sum(skims_alt$NHB_flow_alt)
# 
# HBW_mean_time_alt
# HBO_mean_time_alt
# NHB_mean_time_alt
```