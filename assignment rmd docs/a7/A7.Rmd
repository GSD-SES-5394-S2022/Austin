---
title: "Assignment 7"
author: "Reuven Herzog"
date: "3/20/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load libraries}
library(here)
library(tidyverse)
library(survey)
library(srvyr)
library(naniar)
library(jtools)
library(knitr)
```

## Data Import and Manipulation

First we need to bring in our National Household Travel Survey data.
(Obtained from https://nhts.ornl.gov/)

We already filtered the complete dataset to only Austin data, so it could
fit on our Github repo.
(See adjacent "A7 get only austin data.rmd")

```{r bring in NHTS data}
austin_trips <- read_csv(here(
                        "assignment rmd docs",
                        "a7",
                        "austin_trips.csv"))

austin_hhs <- read_csv(here(
                      "assignment rmd docs",
                      "a7",
                      "austin_hhs.csv"))
```

Code blocks adapted from skills page. This first one creates the variables for HH income quintiles, HH sizes, and vehicle availability.

```{r}
austin_hhs <- austin_hhs %>%
  mutate(inc_quint_ = case_when(HHFAMINC == "01" ~ "1st",
                               HHFAMINC == "02" ~ "1st",
                               HHFAMINC == "03" ~ "1st",
                               HHFAMINC == "04" ~ "2nd",
                               HHFAMINC == "05" ~ "2nd",
                               HHFAMINC == "06" ~ "3rd",
                               HHFAMINC == "07" ~ "4th",
                               HHFAMINC == "08" ~ "5th",
                               HHFAMINC == "09" ~ "5th",
                               HHFAMINC == "10" ~ "5th",
                               HHFAMINC == "11" ~ "5th",
                               TRUE ~ "NA")) %>%
  mutate(size_ = case_when(HHSIZE == 1 ~ "one",
                              HHSIZE == 2 ~ "two",
                              HHSIZE == 3 ~ "three",
                              TRUE ~ "four_plus")) %>%
  mutate(children_ = case_when(HHSIZE > NUMADLT ~ "yes",
                               TRUE ~ "no")) %>%
  mutate(zero_veh_ = (HHVEHCNT == 0)) %>%
  replace_with_na(list(inc_quint_ = "NA")) %>%
  select(HOUSEID, zero_veh_, size_, children_, inc_quint_, WTHHFIN) 
```

The following block creates variables for home-based and work-based trips, then groups them so we know the number of trip types by each household in the survey.

```{r}
trips_by_purpose <- austin_trips %>%
  select(HOUSEID, WHYFROM, WHYTO) %>%
  mutate(home_based = case_when(WHYTO == "01" ~ TRUE,
                                WHYTO == "02" ~ TRUE,
                                WHYFROM == "01" ~ TRUE,
                                WHYFROM == "02" ~ TRUE,
                                TRUE ~ FALSE)) 

trips_by_purpose <- trips_by_purpose %>%
  mutate(work = ifelse(WHYTO == "03" | WHYFROM == "03", TRUE, FALSE)) %>%
  mutate(purpose = case_when(home_based & work ~ "HBW",
                            home_based ~ "HBO",
                            TRUE ~ "NHB")) %>%
  group_by(HOUSEID, purpose)

trips_by_purpose <- trips_by_purpose %>%
  summarize(n = n()) %>%
  pivot_wider(names_from = "purpose", values_from = "n") 
```

Dealing with lots of "NA" entries and replacing them with zeros.

```{r}
hh_trips <- left_join(austin_hhs, trips_by_purpose) %>%
  replace_na(list(HBW = 0,
                  HBO = 0,
                  NHB = 0))
```

```{r}
svy_trips <- hh_trips %>%
  as_survey(weights = WTHHFIN)
```

## Trip Production

First HBO model. Same result as the skills page example; only HH size seems to be significant. Added presence of children (members of HH under 18) to the model as well, since we can get that easily in the ACS (in terms of HHs with children)

```{r}
HBO_model1 <- svyglm(HBO ~ zero_veh_ + size_ + inc_quint_ + children_, svy_trips)

# export_summs(HBO_model1, 
#              error_pos = "right", 
#              error_format = "(p = {p.value})",
#              model.names = "Full model")
```

Model attempt #2: now with only HH size. Compared with the first model as well.

```{r}
HBO_model2 <- svyglm(HBO ~ size_, svy_trips)

export_summs(HBO_model1, HBO_model2,
             error_pos = "right", 
             error_format = "(p = {p.value})",
             model.names = c("Full model", "Reduced model"))
```

This next code block just adds the number of households with children to our zone data and saves it to the repo. No need to run it after the first time.

```{r}
# vars <- c(hh_children = 'B09005_001')
# 
# counties <- c("Travis", 
#               "Bastrop", 
#               "Hays", 
#               "Caldwell", 
#               "Williamson")
# 
# census_data <- get_acs(geography = "tract",
#                        state = "TX",
#                        variables = vars,
#                        county = counties,
#                        output = "wide",
#                        geometry = FALSE) %>%
#   select(GEOID, hh_childrenE)
# 
# census_data$GEOID <- as.numeric(census_data$GEOID)
# 
# existing_zones <- here("existing",
#                        "data",
#                        "zone_data.csv") %>%
#   read_csv() %>%
#   left_join(census_data, by = "GEOID")
# 
# write.csv(existing_zones, here("existing",
#                                "data",
#                                "zone_data.csv"))
```

Apply trip production model to zone data for HBO trips. Because our alternative does not change any of the underlying factors in the trip production model, we do not need to repeat this process and can use the same estimates. 

```{r}
existing_zones <- here("existing",
                       "data",
                       "zone_data.csv") %>%
  read_csv() %>%
  mutate(hbo_prod = hh_totalE * HBO_model2$coefficients["(Intercept)"] +
                    hh_1personE * HBO_model2$coefficients["size_one"] +
                    hh_2personE * HBO_model2$coefficients["size_two"] +
                    hh_3personE * HBO_model2$coefficients["size_three"])
```

Repeating the model process for HBW trips. HH size matters as before, as does the presence of household members under the age of 18. 

```{r}
HBW_model1 <- svyglm(HBW ~ zero_veh_ + size_ + inc_quint_ + children_, svy_trips)

HBW_model2 <- svyglm(HBW ~ size_ + children_, svy_trips)

export_summs(HBW_model1, HBW_model2,
             error_pos = "right", 
             error_format = "(p = {p.value})",
             model.names = c("Full model", "Reduced model"))
```

Applying the trip production model to our zone data for HBW trips.

```{r}
existing_zones <- existing_zones %>%
mutate(hbw_prod = hh_totalE * HBW_model2$coefficients["(Intercept)"] +
                  hh_1personE * HBW_model2$coefficients["size_one"] +
                  hh_2personE * HBW_model2$coefficients["size_two"] +
                  hh_3personE * HBW_model2$coefficients["size_three"] +
                  hh_childrenE * HBW_model2$coefficients["children_yes"])
```

Presence of children in the surveyed HHs does not appear to matter here for NHB trips, but income does. Though the coefficient on the 2nd income quintile is statistically insignificant, it is only marginally so.

```{r}
NHB_model1 <- svyglm(NHB ~ zero_veh_ + size_ + inc_quint_ + children_, svy_trips)

NHB_model2 <- svyglm(NHB ~ size_ + inc_quint_, svy_trips)

export_summs(NHB_model1, NHB_model2,
             error_pos = "right", 
             error_format = "(p = {p.value})",
             model.names = c("Full model", "Reduced model"))
```

```{r}
existing_zones <- existing_zones %>%
mutate(nhb_prod = hh_totalE * NHB_model2$coefficients["(Intercept)"] +
                  hh_1personE * NHB_model2$coefficients["size_one"] +
                  hh_2personE * NHB_model2$coefficients["size_two"] +
                  hh_3personE * NHB_model2$coefficients["size_three"] +
                  inc_quint_2 * NHB_model2$coefficients["inc_quint_2nd"] +
                  inc_quint_3 * NHB_model2$coefficients["inc_quint_3rd"] +
                  inc_quint_4 * NHB_model2$coefficients["inc_quint_4th"] +
                  inc_quint_5 * NHB_model2$coefficients["inc_quint_5th"])
```

## Trip Attraction

```{r}
existing_zones <- existing_zones %>%
  replace_na(list(basic_emp = 0,
                  retail_emp = 0, 
                  service_emp = 0)) %>%
  mutate(hbo_attr = 0.7 * hh_totalE +
                    0.7 * basic_emp +
                    8.4 * retail_emp +
                    3.5 * service_emp,
         hbw_attr = 1.2 * total_emp,
         nhb_attr = 0.6 * hh_totalE +
                    0.5 * basic_emp +
                    4.7 * retail_emp +
                    1.4 * service_emp)
```

## Balancing Trip Production and Attraction

### HBO Trip Balancing

```{r}
trip_end_summary <- tibble(Purpose = c("HBO"),
                           Productions = c(sum(existing_zones$hbo_prod)),
                           Attractions = c(sum(existing_zones$hbo_attr)),
                           Difference = c(sum(existing_zones$hbo_attr) - 
                                            sum(existing_zones$hbo_prod)))

kable(trip_end_summary, format.args = list(big.mark = ","))
```

```{r}
existing_zones <- existing_zones %>%
  mutate(hbo_attr_bal = hbo_attr * 
           sum(existing_zones$hbo_prod) / sum(existing_zones$hbo_attr))
```

```{r}
trip_end_summary <- tibble(Purpose = c("HBO"),
                           Productions = c(sum(existing_zones$hbo_prod)),
                           Attractions = c(sum(existing_zones$hbo_attr_bal)),
                           Difference = c(sum(existing_zones$hbo_attr_bal) - 
                                            sum(existing_zones$hbo_prod)))

kable(trip_end_summary, format.args = list(big.mark = ","))
```

### HBW Trip Balancing

```{r}
trip_end_summary <- tibble(Purpose = c("HBW"),
                           Productions = c(sum(existing_zones$hbw_prod)),
                           Attractions = c(sum(existing_zones$hbw_attr)),
                           Difference = c(sum(existing_zones$hbw_attr) - 
                                            sum(existing_zones$hbw_prod)))

kable(trip_end_summary, format.args = list(big.mark = ","))
```

```{r}
existing_zones <- existing_zones %>%
  mutate(hbw_attr_bal = hbw_attr * 
           sum(existing_zones$hbw_prod) / sum(existing_zones$hbw_attr))
```

```{r}
trip_end_summary <- tibble(Purpose = c("HBW"),
                           Productions = c(sum(existing_zones$hbw_prod)),
                           Attractions = c(sum(existing_zones$hbw_attr_bal)),
                           Difference = c(sum(existing_zones$hbw_attr_bal) - 
                                            sum(existing_zones$hbw_prod)))

kable(trip_end_summary, format.args = list(big.mark = ","))
```

### NHB Trip Balancing

```{r}
trip_end_summary <- tibble(Purpose = c("NHB"),
                           Productions = c(sum(existing_zones$nhb_prod)),
                           Attractions = c(sum(existing_zones$nhb_attr)),
                           Difference = c(sum(existing_zones$nhb_attr) - 
                                            sum(existing_zones$nhb_prod)))

kable(trip_end_summary, format.args = list(big.mark = ","))
```

```{r}
existing_zones <- existing_zones %>%
  mutate(nhb_attr_bal = nhb_attr * 
           sum(existing_zones$nhb_prod) / sum(existing_zones$nhb_attr))
```

```{r}
trip_end_summary <- tibble(Purpose = c("NHB"),
                           Productions = c(sum(existing_zones$nhb_prod)),
                           Attractions = c(sum(existing_zones$nhb_attr_bal)),
                           Difference = c(sum(existing_zones$nhb_attr_bal) - 
                                            sum(existing_zones$nhb_prod)))

kable(trip_end_summary, format.args = list(big.mark = ","))
```