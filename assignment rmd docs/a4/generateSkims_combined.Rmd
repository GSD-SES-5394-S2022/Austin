---
title: "Generate Combined Skims"
author: "Reuven Herzog and Chris Dsida"
date: "2/21/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## script overview

This Rmd doc contains the scripts to generate travel skims.
We will be doing skims for the following modes: car, transit, pedestrian, bicycle.
We also will be running transit skims for 3 times of day:
8:15, 12:30, and 17:15, to correspond to the morning and evening rushes,
plus a mid-day travel time.

Our chosen date for the skim is Wednesday, April 6, 2022.

```{r load libraries}
# allocate more memory to Java for using r5r
options(java.parameters = "-Xmx4G")
library(r5r)

library(tidyverse)
library(here)

library(lubridate)
library(sf)
```

```{r load centroids}
centroids <- st_read(here("zones",
                          "centroids.geojson"))
```

#Existing network travel skims

```{r setup r5 core}
alt_core <- here("alternative",
                 "networks") %>%
  setup_r5(verbose = FALSE)
```




```{r alt driving skim}
car_skim_alt <- travel_time_matrix(alt_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "CAR")
```

```{r walking skim}
walk_skim_alt <- travel_time_matrix(alt_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "WALK")
```

```{r biking skim}
bike_skim_alt <- travel_time_matrix(alt_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "BICYCLE")
```

```{r transit skim morning rush}
trans_skim_alt_morn <- travel_time_matrix(alt_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "TRANSIT",
                     departure_datetime = ymd_hm("2022-04-06 08:30"),
                     breakdown = TRUE)
```

# ```{r transit skim evening rush}
# trans_skim_alt_eve <- travel_time_matrix(existing_core, 
#                      origins = centroids,
#                      destinations = centroids,
#                      mode = "TRANSIT",
#                      departure_datetime = ymd_hm("2022-04-06 17:15"),
#                      breakdown = TRUE)
# ```
# 
# ```{r transit skim midday}
# trans_skim_alt_midday <- travel_time_matrix(existing_core, 
#                      origins = centroids,
#                      destinations = centroids,
#                      mode = "TRANSIT",
#                      departure_datetime = ymd_hm("2022-04-06 12:30"),
#                      breakdown = TRUE)
# ```

```{r stop existing core}
stop_r5()
```

```{r}
trans_skim_alt_morn <- trans_skim_alt_morn %>%
  filter(n_rides > 0)

car_skim_alt <- car_skim_alt %>%
  rename(car_time = travel_time) 

trans_skim_alt_morn <- trans_skim_alt_morn %>%
  rename(transit_time = travel_time) 

walk_skim_alt <- walk_skim_alt %>%
  rename(walk_time = travel_time)

bike_skim_alt <- bike_skim_alt %>%
  rename(bike_time = travel_time)

all_skims_alt <- full_join(trans_skim_alt_morn, car_skim_alt) %>%
  full_join(walk_skim_alt) %>%
  full_join(bike_skim_alt)



write_csv(all_skims_alt, here("alternative",
                              "data",
                              "all_skims_alt.csv"))
```


```{r setup r5 core}
ex_core <- here("existing",
                 "networks") %>%
  setup_r5(verbose = FALSE)
```

```{r existing driving skim}
car_skim_ex <- travel_time_matrix(ex_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "CAR")
```

```{r walking skim}
walk_skim_ex <- travel_time_matrix(ex_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "WALK")
```

```{r biking skim}
bike_skim_ex <- travel_time_matrix(ex_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "BICYCLE")
```

```{r transit skim morning rush}
trans_skim_ex_morn <- travel_time_matrix(ex_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "TRANSIT",
                     departure_datetime = ymd_hm("2022-04-06 08:30"),
                     breakdown = TRUE)
```

```{r stop existing core}
stop_r5()
```

```{r}
trans_skim_ex_morn <- trans_skim_ex_morn %>%
  filter(n_rides > 0)

car_skim_ex <- car_skim_ex %>%
  rename(car_time = travel_time) 

trans_skim_ex_morn <- trans_skim_ex_morn %>%
  rename(transit_time = travel_time) 

walk_skim_ex <- walk_skim_ex %>%
  rename(walk_time = travel_time)

bike_skim_ex <- bike_skim_ex %>%
  rename(bike_time = travel_time)

all_skims_ex <- full_join(trans_skim_ex_morn, car_skim_ex) %>%
  full_join(walk_skim_ex) %>%
  full_join(bike_skim_ex)



write_csv(all_skims_ex, here("existing",
                             "data",
                             "all_skims_ex.csv"))
```

```{r}
all_skims_alt <- read.csv(here("alternative",
                              "data",
                              "all_skims_alt.csv"))

all_skims_ex <- read.csv(here("existing",
                             "data",
                             "all_skims_ex.csv"))

car_mat_ex <- all_skims_ex %>% 
  select(fromId, toId, car_time) %>%
  pivot_wider(names_from = toId, 
              values_from = car_time) %>%
  column_to_rownames("fromId")

car_mat_alt <- all_skims_alt %>%
  select(fromId, toId, car_time) %>%
  pivot_wider(names_from = toId, 
              values_from = car_time) %>%
  column_to_rownames("fromId")

# walk_mat_ex <- all_skims_ex %>% 
#   select(fromId, toId, walk_time) %>%
#   pivot_wider(names_from = toId, 
#               values_from = walk_time) %>%
#   column_to_rownames("fromId")
# 
# walk_mat_alt <- all_skims_alt %>%
#   select(fromId, toId, walk_time) %>%
#   pivot_wider(names_from = toId, 
#               values_from = walk_time) %>%
#   column_to_rownames("fromId")
# 
# bike_mat_ex <- all_skims_ex %>% 
#   select(fromId, toId, bike_time) %>%
#   pivot_wider(names_from = toId, 
#               values_from = bike_time) %>%
#   column_to_rownames("fromId")
# 
# bike_mat_alt <- all_skims_alt %>%
#   select(fromId, toId, bike_time) %>%
#   pivot_wider(names_from = toId, 
#               values_from = bike_time) %>%
#   column_to_rownames("fromId")
```

```{r}
car_diff <- car_mat_ex - car_mat_alt

total_diff <- car_diff %>%
  replace(is.na(.), 0) %>%
  mutate(total_diff = rowSums(across())) %>%
  select(total_diff) %>%
  rownames_to_column("GEOID")

# walk_diff <- walk_mat_ex - walk_mat_alt
# 
# total_diff_walk <- walk_diff %>%
#   replace(is.na(.), 0) %>%
#   mutate(total_diff = rowSums(across())) %>%
#   select(total_diff) %>%
#   rownames_to_column("GEOID")
# 
# bike_diff <- bike_mat_ex - bike_mat_alt
# 
# total_diff_bike <- bike_diff %>%
#   replace(is.na(.), 0) %>%
#   mutate(total_diff = rowSums(across())) %>%
#   select(total_diff) %>%
#   rownames_to_column("GEOID")
```

```{r}
# zones <- st_read(here("zones",
#                        "boundaries.geojson"))
```

```{r}
existing_max_diff <- car_mat_ex %>%
  rownames_to_column("GEOID") %>%
  select(GEOID, `48453001100`) %>%
  rename(existing = `48453001100`)

alt_max_diff <- car_mat_alt %>%
  rownames_to_column("GEOID") %>%
  select(GEOID, `48453001100`) %>%
  rename(alt = `48453001100`)


zones <- here("zones",
              "boundaries.geojson") %>%
  st_read() %>%
  inner_join(existing_max_diff) %>%
  inner_join(alt_max_diff) %>%
  mutate(diff = alt - existing)

existing_max_diff2 <- car_mat_ex %>%
  rownames_to_column("GEOID") %>%
  select(GEOID, `48453000700`) %>%
  rename(existing = `48453000700`)

alt_max_diff2 <- car_mat_alt %>%
  rownames_to_column("GEOID") %>%
  select(GEOID, `48453000700`) %>%
  rename(alt = `48453000700`)


zones2 <- here("zones",
              "boundaries.geojson") %>%
  st_read() %>%
  inner_join(existing_max_diff2) %>%
  inner_join(alt_max_diff2) %>%
  mutate(diff = alt - existing)
```

```{r}
# existing_max_diff_walk <- walk_mat_ex %>%
#   rownames_to_column("GEOID") %>%
#   select(GEOID, `48453001100`) %>%
#   rename(existing = `48453001100`)
# 
# alt_max_diff_walk <- walk_mat_alt %>%
#   rownames_to_column("GEOID") %>%
#   select(GEOID, `48453001100`) %>%
#   rename(alt = `48453001100`)
# 
# 
# zones <- here("zones",
#               "boundaries.geojson") %>%
#   st_read() %>%
#   inner_join(existing_max_diff_walk) %>%
#   inner_join(alt_max_diff_walk) %>%
#   mutate(diff = alt - existing)
```

```{r}
# existing_max_diff_bike <- bike_mat_ex %>%
#   rownames_to_column("GEOID") %>%
#   select(GEOID, `48453001100`) %>%
#   rename(existing = `48453001100`)
# 
# alt_max_diff_bike <- bike_mat_alt %>%
#   rownames_to_column("GEOID") %>%
#   select(GEOID, `48453001100`) %>%
#   rename(alt = `48453001100`)
# 
# 
# zones <- here("zones",
#               "boundaries.geojson") %>%
#   st_read() %>%
#   inner_join(existing_max_diff_bike) %>%
#   inner_join(alt_max_diff_bike) %>%
#   mutate(diff = alt - existing)
```

```{r}
library(ggthemes)
library(RColorBrewer)

map_palette <- brewer.pal(5, "YlOrBr")

map_existing <- ggplot(zones) +
  geom_sf(aes(fill = existing),
          color = NA) +
  geom_sf(data = zones[zones$GEOID=="48453001100",],
          fill = "blue",
          color = "blue") +
  scale_fill_gradientn(colours = map_palette,
                       name = "Travel time\n(existing)") +
  theme_void()

map_existing

ggsave("ex_car_times_tract1.png",
       path = here("images",
                   "a4"),
       width = 7.5,
       height = 7.5,
       units = "in")
```

```{r}
map_alt <- ggplot(zones) +
  geom_sf(aes(fill = alt),
          color = NA) +
  geom_sf(data = zones[zones$GEOID=="48453001100",],
          fill = "blue",
          color = "blue") +
  scale_fill_gradientn(colours = map_palette,
                       name = "Travel time\n(alternative)") +
  theme_void()

map_alt

ggsave("alt_car_times_tract1.png",
       path = here("images",
                   "a4"),
       width = 7.5,
       height = 7.5,
       units = "in")
```

```{r}
map_dif <- ggplot(zones) +
  geom_sf(aes(fill = diff),
          color = NA) +
  geom_sf(data = zones[zones$GEOID=="48453001100",],
          fill = "blue",
          color = "blue") +
  scale_fill_gradientn(colours = map_palette,
                       name = "Difference\nin travel times") +
  theme_void()

map_dif

ggsave("dif_car_times_tract1.png",
       path = here("images",
                   "a4"),
       width = 7.5,
       height = 7.5,
       units = "in")
```

```{r}

map_existing2 <- ggplot(zones2) +
  geom_sf(aes(fill = existing),
          color = NA) +
  geom_sf(data = zones2[zones2$GEOID=="48453000700",],
          fill = "blue",
          color = "blue") +
  scale_fill_gradientn(colours = map_palette,
                       name = "Travel time\n(existing)") +
  theme_void()

map_existing2

ggsave("ex_car_times_tract2.png",
       path = here("images",
                   "a4"),
       width = 7.5,
       height = 7.5,
       units = "in")
```

```{r}
map_alt2 <- ggplot(zones2) +
  geom_sf(aes(fill = alt),
          color = NA) +
  geom_sf(data = zones[zones$GEOID=="48453000700",],
          fill = "blue",
          color = "blue") +
  scale_fill_gradientn(colours = map_palette,
                       name = "Travel time\n(alternative)") +
  theme_void()

map_alt2

ggsave("alt_car_times_tract2.png",
       path = here("images",
                   "a4"),
       width = 7.5,
       height = 7.5,
       units = "in")
```

```{r}
map_dif2 <- ggplot(zones2) +
  geom_sf(aes(fill = diff),
          color = NA) +
  geom_sf(data = zones[zones$GEOID=="48453000700",],
          fill = "blue",
          color = "blue") +
  scale_fill_gradientn(colours = map_palette,
                       name = "Difference\nin travel times") +
  theme_void()

map_dif2

ggsave("dif_car_times_tract2.png",
       path = here("images",
                   "a4"),
       width = 7.5,
       height = 7.5,
       units = "in")
```