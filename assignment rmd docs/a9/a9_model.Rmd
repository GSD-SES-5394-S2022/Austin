---
title: "a9"
author: "Reuven Herzog"
date: "4/5/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

We are building a mode choice model for Austin, TX.
Our travel skims are the same as from earlier in our model construction,
taken for April 6, 2022.

```{r load libraries}
library(here)
library(tidyverse)
library(sf)
library(knitr)
library(kableExtra)
library(survey)
library(srvyr)
```

# Travel Cost

## Transit Cost

We need to bring in monetary cost data. We obtain it from the National Transit
Database. Even though our model is for 2022, the most recent data we can obtain
is for 2020. However, to avoid confusion by the effects of the Covid-19 Pandemic,
we'll go with 2019 data instead.

Source: https://www.transit.dot.gov/sites/fta.dot.gov/files/transit_agency_profile_doc/2019/60048.pdf

Austin's transit agency, Capital Metro, has 2 primary modes of fixed-route
travel - bus and rail (a single commuter line, the Red Line),
and the bus network is divided into 2 categories: "bus" and "commuter bus."
Of these 3, the regular bus mode is by far the largest.
(CTMA also has a "Demand Response" and "Vanpool" travel. However, these are not
described in our GTFS data, so functionally they are not included in our model's
transit options.)
We don't know yet if our model can handle such subdivision, but let's hold onto
as much cost data for now as we can.


```{r transit cost}
#Fare Revenues
revenue_bus_reg = 16515594
revenue_bus_commuter = 2113839
revenue_rail = 1526429

#Annual Unlinked Trips
trips_bus_reg = 28313270
trips_bus_commuter = 779887
trips_rail = 729507

#Derived values
revenue_bus_all = revenue_bus_reg + revenue_bus_commuter
revenue_total = revenue_bus_reg + revenue_bus_commuter + revenue_rail

trips_bus_all = trips_bus_reg + trips_bus_commuter
trips_total = trips_bus_reg + trips_bus_commuter + trips_rail

#Organize this data into tables
cost_disagg <- data.frame(mode = c("bus","commuter bus","rail"),
                  revenue = c(revenue_bus_reg,revenue_bus_commuter,revenue_rail),
                  trips = c(trips_bus_reg,trips_bus_commuter,trips_rail)) %>%
  mutate(cost_per_ride = revenue/trips)

cost_sums <- data.frame(mode = c("bus combined","all modes"),
                        revenue = c(revenue_bus_all, revenue_total),
                        trips = c(trips_bus_all, trips_total)) %>%
  mutate(cost_per_ride = revenue/trips)

#highlight the *all modes combined* cost per ride
cost_per_ride_combined <- revenue_total / trips_total
```


(For GTFS data, commuter fares cover Routes 900-999 and Route 550 = the Red Line.
Everything else is local fares.)

Naturally, the regular bus dominates the data, and the combined per-ride cost
is very close to the regular bus per-ride cost. This per-ride bus cost is
remarkably cheap: 58 cents per trip!


A single bus fare is advertised as $1.25. 7-day passes average this cost with
19 trips in a week. 31-day passes average this cost with 71 rides a month, which
is a lot, but not a crazy amount (3.5 trips per workday, assuming 20 workdays a month.
So our per-ride cost is probably resulted from a combination of
- Lots of monthly passes
- Transfers

Interestingly, even though the commuter buses and rail line share the same fare
structure, their derived per-ride costs are different. ($2.70 for the commuter bus
vs $2.10 for the rail line.) This implies that ridership trends are different; maybe
rail riders are more likely to use monthly passes?


--
## Driving cost

Now let's move to driving cost per minute:

```{r driving cost}
#Austin MSA's FIPS code is 12420

temp <- tempfile()
download.file("https://nhts.ornl.gov/assets/2016/download/csv.zip", temp)

vehs <- read_csv(unz(temp, "vehpub.csv"), 
                 show_col_types = FALSE) %>%
  filter(HH_CBSA == "12420")

trips <- read_csv(unz(temp, "trippub.csv"), 
                      show_col_types = FALSE) %>%
  filter(HH_CBSA == "12420")

car_trips <- trips %>%
  filter(PSGR_FLG == "02") 
  
unlink(temp)



```

```{r driving cost cont}
car_trips_svy <- car_trips %>%
  as_survey(weights = WTTRDFIN)

veh_svy <- vehs %>%
  as_survey(weights = WTHHFIN)

total_time <- car_trips_svy %>%
  summarise(total_time = survey_total(TRVLCMIN))

kable(total_time, format.args = list(big.mark = ",",
                                     scientific = FALSE))
```

Austin drivers drive around 35.7 Billion minutes annually. With a 2016 population
at 1.7 million, that's around 21,000 minutes per person per year, or around 57 minutes
per person per day.

```{r gas cost summary}
total_gas_cost <- veh_svy %>%
  summarise(total_cost = survey_total(GSTOTCST))

kable(total_gas_cost, format.args = list(big.mark = ","))
```
Households in Austin spend around $1.8 Billion on gas each year. Per person this
comes out to approximately \$1000 annually, or \$2.70 per day

```{r cost per minute}
cost_per_minute <- total_gas_cost$total_cost[1] / total_time$total_time[1] 

cost_per_minute
```

Around 5.2 cents per minute to operate a car in Austin.


## Costs per Trip

```{r load up skims}
skims <- here("existing",
              "data",
              "all_skims_ex.csv") %>%
  read_csv(show_col_types = FALSE) %>%
  mutate(fromId = as.character(fromId),
         toId = as.character(toId))

head(skims, 5) %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(width = "500px", height = "320px")

skims <- skims %>%
  mutate(drive_cost = car_time * cost_per_minute) %>%
  mutate(transit_cost = n_rides * cost_per_ride_combined)


#use the NCHRP 716 Table 4.16 to assume average size of carpools at 2.42 ppl
skims <- skims %>%
  mutate(carpool_cost = drive_cost / 2.42)
```

## Estimate existing mode shares

Note about mode shares and costs: Ideally we would want to separate into
a nest for transit, with bus splitting into local and commuter, and rail separate.
However, fare-wise rail and commuter bus are comparable. But the NHTS data does
*not* distinguish between commuter bus and local bus service. Therefore we could
only disaggregate data to all bus vs. rail. And that seems a bit silly, since our
bus data is somewhat skewed. So we might as well just lump it all into a single
transit factor.
(Plus disaggregating would require us to go back to the travel time skims and try
to disaggregate it there, which is annoying...)


First, let's just get an overview of our mode breakdown at the least aggregated level:
```{r}
mode_count <- count(trips, TRPTRANS) %>%
  mutate(mode = c("walk","bike","car","suv","van","pickup truck",'golf cart/segway',
           'motorcycle','rv','school bus','public or commuter bus','paratransit',
           'private/charter bus','amtrak/commuter rail',
           'subway/light rail','taxi/uber','rental/zipcar','airplane','ferry',
           'something else'))
mode_count
```


Note on data aggregation: We are choosing to count "transit trips" as only
those which are by public bus, or heavy or light rail. This is so that our mode
choice data matches our travel time data, which is based off GTFS that only
includes bus and rail. School bus trips, paratransit trips, charter bus trips
will all be discounted from our model.

Really, the aforementioned 3 modes should be their own category. They all feature
indirect travel, and often are directionally sensitive - children board
individually in mornings, but as a unit in the afternoon.
(Paratransit is also such a small segment of the NHTS data that excluding it won't
skew much.)

Ultimately the reason to exclude these modes from our model is that we don't have
travel time estimates for them. They don't move like standard driving trips, nor
do they line up with the GTFS data for fixed-route trips.


(I'm still not certain what trips are classified as commuter rail vs light rail.
Especially since Amtrak travel is not possible _within_ the metro area, only
external trips. I think we can assume that both commuter rail trips and subway/
light rail trips are referring to the same mode.)



```{r aggregate trip data by mode}

#codebook source: https://nhts.ornl.gov/assets/codebook_v1.2.pdf

trips <- trips %>%
  mutate(home_based = case_when(WHYTO == "01" ~ TRUE,
                                WHYTO == "02" ~ TRUE,
                                WHYFROM == "01" ~ TRUE,
                                WHYFROM == "02" ~ TRUE,
                                TRUE ~ FALSE)) %>%
  mutate(work = ifelse(WHYTO == "03" | WHYFROM == "03", TRUE, FALSE)) %>%
  mutate(purpose = case_when(home_based & work ~ "HBW",
                            home_based ~ "HBO",
                            TRUE ~ "NHB")) %>%
  mutate(mode = case_when(TRPTRANS == "01" ~ "walk",
                          TRPTRANS == "02" ~ "bike",
                          TRPTRANS == "03" & NUMONTRP > 1 ~ "HOV", #car
                          TRPTRANS == "04" & NUMONTRP > 1 ~ "HOV", #SUV
                          TRPTRANS == "05" & NUMONTRP > 1 ~ "HOV", #van
                          TRPTRANS == "06" & NUMONTRP > 1 ~ "HOV", #pickup truck
                          TRPTRANS == "08" & NUMONTRP > 1 ~ "HOV", #motorcycle/moped
                          TRPTRANS == "17" & NUMONTRP > 1 ~ "HOV", #taxi/Uber
                          TRPTRANS == "18" & NUMONTRP > 1 ~ "HOV", #rental/Zipcar
                          TRPTRANS == "03" ~ "SOV",
                          TRPTRANS == "04" ~ "SOV",
                          TRPTRANS == "05" ~ "SOV",
                          TRPTRANS == "06" ~ "SOV",
                          TRPTRANS == "08" ~ "SOV",
                          TRPTRANS == "17" ~ "SOV",
                          TRPTRANS == "18" ~ "SOV",
                          TRPTRANS == "11" ~ "transit", #public or commuter bus
                          #TRPTRANS == "14" ~ "transit", #city-to-city bus
                          TRPTRANS == "15" ~ "transit", #amtrak/commuter rail
                          TRPTRANS == "16" ~ "transit", #subway/light rail
                          TRPTRANS == "10" ~ "Group Travel", #school bus
                          TRPTRANS == "12" ~ "Group Travel", #paratransit
                          TRPTRANS == "13" ~ "Group Travel", #charter bus
                          TRUE ~ "other")) %>%
  filter(mode != "other")
```


```{r survey trips by mode}
trips_svy <- trips %>%
  as_survey(weights = WTTRDFIN)

mode_by_purpose <- trips_svy %>%
  group_by(purpose, mode) %>%
  survey_tally() %>%
  select(-n_se) %>%
  pivot_wider(names_from = mode,
              values_from = n,
              names_prefix = "n_",) %>%
  mutate(n_trips = n_bike + n_SOV + n_HOV + n_transit + n_walk) %>%
  mutate(pct_bike = n_bike / n_trips) %>%
  mutate(pct_SOV = n_SOV / n_trips) %>%
  mutate(pct_HOV = n_HOV / n_trips) %>%
  mutate(pct_walk = n_walk / n_trips) %>%
  mutate(pct_transit = n_transit / n_trips) %>%
  select(purpose, pct_bike, pct_SOV, pct_HOV, pct_transit, pct_walk)

mode_by_purpose

```


## Applying the model

For our model choice, we're using NCHRP tables. We are looking for models
that fit our population size and include non-motorized travel. (Breaking down transit
into submodes would be nice, but isn't necessary, especially since rail travel is such
a small segment of transit trips in Austin.)

HBW - Table 4.7/8 Model H
HBO - Table 4.10/11 Model I
NHB - Table 4.13/14 Model M


```{r mode-specific constants}
SOV_share_HBW <- mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "HBW"]
HOV_share_HBW <- mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "HBW"]
transit_share_HBW <- mode_by_purpose$pct_transit[mode_by_purpose$purpose == "HBW"]
walk_share_HBW <- mode_by_purpose$pct_walk[mode_by_purpose$purpose == "HBW"]
bike_share_HBW <- mode_by_purpose$pct_bike[mode_by_purpose$purpose == "HBW"]

SOV_const_HBW <- log(SOV_share_HBW / (1 - SOV_share_HBW))
HOV_const_HBW <- log(HOV_share_HBW / (1 - HOV_share_HBW))
transit_const_HBW <- log(transit_share_HBW / (1 - transit_share_HBW))
walk_const_HBW <- log(walk_share_HBW / (1 - walk_share_HBW))
bike_const_HBW <- log(bike_share_HBW / (1 - bike_share_HBW))



SOV_share_HBO <- mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "HBO"]
HOV_share_HBO <- mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "HBO"]
transit_share_HBO <- mode_by_purpose$pct_transit[mode_by_purpose$purpose == "HBO"]
walk_share_HBO <- mode_by_purpose$pct_walk[mode_by_purpose$purpose == "HBO"]
bike_share_HBO <- mode_by_purpose$pct_bike[mode_by_purpose$purpose == "HBO"]

SOV_const_HBO <- log(SOV_share_HBO / (1 - SOV_share_HBO))
HOV_const_HBO <- log(HOV_share_HBO / (1 - HOV_share_HBO))
transit_const_HBO <- log(transit_share_HBO / (1 - transit_share_HBO))
walk_const_HBO <- log(walk_share_HBO / (1 - walk_share_HBO))
bike_const_HBO <- log(bike_share_HBO / (1 - bike_share_HBO))


SOV_share_NHB <- mode_by_purpose$pct_SOV[mode_by_purpose$purpose == "NHB"]
HOV_share_NHB <- mode_by_purpose$pct_HOV[mode_by_purpose$purpose == "NHB"]
transit_share_NHB <- mode_by_purpose$pct_transit[mode_by_purpose$purpose == "NHB"]
walk_share_NHB <- mode_by_purpose$pct_walk[mode_by_purpose$purpose == "NHB"]
bike_share_NHB <- mode_by_purpose$pct_bike[mode_by_purpose$purpose == "NHB"]

SOV_const_NHB <- log(SOV_share_NHB / (1 - SOV_share_NHB))
HOV_const_NHB <- log(HOV_share_NHB / (1 - HOV_share_NHB))
transit_const_NHB <- log(transit_share_NHB / (1 - transit_share_NHB))
walk_const_NHB <- log(walk_share_NHB / (1 - walk_share_NHB))
bike_const_NHB <- log(bike_share_NHB / (1 - bike_share_NHB))
```


Now to estimate utilities

```{r utility HBW}
skims <- skims %>%
  mutate(utility_transit_HBW = transit_const_HBW +
                               ride_time * -0.033  +
                               (access_time + 
                                 egress_time) * -0.093 +
                               wait_time * -0.038 +
                               transfer_time * -0.038 +
                               transit_cost * -0.0021,
         utility_SOV_HBW = SOV_const_HBW +
                           car_time * -0.033 +
                           drive_cost * -0.0021,
         utility_HOV_HBW = HOV_const_HBW +
                           car_time * -0.033 +
                           carpool_cost * -0.0021,
         utility_walk_HBW = walk_const_HBW +
                            walk_time * -0.093,
         utility_bike_HBW = bike_const_HBW +
                            bike_time * -0.033) %>%
  mutate(exp_u_walk_HBW = exp(utility_walk_HBW),
         exp_u_bike_HBW = exp(utility_bike_HBW),
         exp_u_SOV_HBW = exp(utility_SOV_HBW),
         exp_u_HOV_HBW = exp(utility_HOV_HBW),
         exp_u_transit_HBW = exp(utility_transit_HBW)) %>%
  rowwise() %>%
  mutate(utility_active_HBW = log(sum(exp_u_walk_HBW, 
                                          exp_u_bike_HBW, 
                                          na.rm = TRUE)),
         utility_car_HBW = log(sum(exp_u_SOV_HBW,
                                       exp_u_HOV_HBW,
                                       na.rm = TRUE))) %>%
  mutate(exp_u_active_HBW = exp(utility_active_HBW),
         exp_u_car_HBW = exp(utility_car_HBW)) %>%
  mutate(total_utility_HBW = sum(exp_u_active_HBW, 
                                 exp_u_car_HBW,
                                 exp_u_transit_HBW,
                                 na.rm = TRUE)) %>%
  ungroup()
```


```{r utility HBO}
skims <- skims %>%
  mutate(utility_transit_HBO = transit_const_HBO +
                               ride_time * -0.008  +
                               (access_time + 
                                 egress_time +
                                 wait_time +
                                 transfer_time) * -0.025 +
                               transit_cost * -0.01,
         utility_SOV_HBO = SOV_const_HBO +
                           car_time * -0.008 +
                           drive_cost * -0.01,
         utility_HOV_HBO = HOV_const_HBO +
                           car_time * -0.008 +
                           carpool_cost * -0.01,
         utility_walk_HBO = walk_const_HBO +
                            walk_time * -0.025,
         utility_bike_HBO = bike_const_HBO +
                            bike_time * -0.025) %>%
  mutate(exp_u_walk_HBO = exp(utility_walk_HBO),
         exp_u_bike_HBO = exp(utility_bike_HBO),
         exp_u_SOV_HBO = exp(utility_SOV_HBO),
         exp_u_HOV_HBO = exp(utility_HOV_HBO),
         exp_u_transit_HBO = exp(utility_transit_HBO)) %>%
  rowwise() %>%
  mutate(utility_active_HBO = log(sum(exp_u_walk_HBO, 
                                          exp_u_bike_HBO, 
                                          na.rm = TRUE)),
         utility_car_HBO = log(sum(exp_u_SOV_HBO,
                                       exp_u_HOV_HBO,
                                       na.rm = TRUE))) %>%
  mutate(exp_u_active_HBO = exp(utility_active_HBO),
         exp_u_car_HBO = exp(utility_car_HBO)) %>%
  mutate(total_utility_HBO = sum(exp_u_active_HBO, 
                                 exp_u_car_HBO,
                                 exp_u_transit_HBO,
                                 na.rm = TRUE)) %>%
  ungroup()
```


```{r utility NHB}
skims <- skims %>%
  mutate(utility_transit_NHB = transit_const_NHB +
                               ride_time * -0.013  +
                               (access_time + 
                                 egress_time) * -0.032 +
                               pmin(wait_time, 7) * -0.032 + #stratified wait time coefs
                               pmax(wait_time - 7, 0) * -0.025 + #stratified wait time coefs
                               transfer_time * -0.050 +
                               (n_rides - 1) * -0.306 + #transfer penalty
                               transit_cost * -0.002,
         utility_SOV_NHB = SOV_const_NHB +
                           car_time * -0.013 +
                           drive_cost * -0.002,
         utility_HOV_NHB = HOV_const_NHB +
                           car_time * -0.013 +
                           carpool_cost * -0.002,
         utility_walk_NHB = walk_const_NHB +
                            walk_time * -0.032,
         utility_bike_NHB = bike_const_NHB +
                            bike_time * -0.013) %>%
  mutate(exp_u_walk_NHB = exp(utility_walk_NHB),
         exp_u_bike_NHB = exp(utility_bike_NHB),
         exp_u_SOV_NHB = exp(utility_SOV_NHB),
         exp_u_HOV_NHB = exp(utility_HOV_NHB),
         exp_u_transit_NHB = exp(utility_transit_NHB)) %>%
  rowwise() %>%
  #this model is not nested
  mutate(total_utility_NHB = sum(exp_u_walk_NHB,
                                 exp_u_bike_NHB,
                                 exp_u_SOV_NHB,
                                 exp_u_HOV_NHB,
                                 exp_u_transit_NHB,
                                 na.rm = TRUE)) %>%
  ungroup()
```


Now we need to add in the probability of taking a particular mode

```{r probability HBW}
skims <- skims %>%
  mutate(p_transit_HBW = exp(utility_transit_HBW) / total_utility_HBW,
         p_car_HBW = exp(utility_car_HBW) / total_utility_HBW,
         p_active_HBW = exp(utility_active_HBW) / total_utility_HBW) 

skims <- skims %>%
  mutate(p_SOV_if_car_HBW = exp(utility_SOV_HBW) / exp(utility_car_HBW),
         p_HOV_if_car_HBW = exp(utility_HOV_HBW) / exp(utility_car_HBW),
         p_walk_if_active_HBW = exp(utility_walk_HBW) / exp(utility_active_HBW),
         p_bike_if_active_HBW = exp(utility_bike_HBW) / exp(utility_active_HBW))

skims <- skims %>%
  mutate(p_SOV_HBW = p_SOV_if_car_HBW * p_car_HBW,
         p_HOV_HBW = p_HOV_if_car_HBW * p_car_HBW,
         p_walk_HBW = p_walk_if_active_HBW * p_active_HBW,
         p_bike_HBW = p_bike_if_active_HBW * p_active_HBW) 
```

```{r probability HBO}
skims <- skims %>%
  mutate(p_transit_HBO = exp(utility_transit_HBO) / total_utility_HBO,
         p_car_HBO = exp(utility_car_HBO) / total_utility_HBO,
         p_active_HBO = exp(utility_active_HBO) / total_utility_HBO) 

skims <- skims %>%
  mutate(p_SOV_if_car_HBO = exp(utility_SOV_HBO) / exp(utility_car_HBO),
         p_HOV_if_car_HBO = exp(utility_HOV_HBO) / exp(utility_car_HBO),
         p_walk_if_active_HBO = exp(utility_walk_HBO) / exp(utility_active_HBO),
         p_bike_if_active_HBO = exp(utility_bike_HBO) / exp(utility_active_HBO))

skims <- skims %>%
  mutate(p_SOV_HBO = p_SOV_if_car_HBO * p_car_HBO,
         p_HOV_HBO = p_HOV_if_car_HBO * p_car_HBO,
         p_walk_HBO = p_walk_if_active_HBO * p_active_HBO,
         p_bike_HBO = p_bike_if_active_HBO * p_active_HBO) 
```

```{r probability NHB}
skims <- skims %>%
  mutate(p_transit_NHB = exp(utility_transit_NHB) / total_utility_NHB,
         p_SOV_NHB = exp(utility_SOV_NHB) / total_utility_NHB,
         p_HOV_NHB = exp(utility_HOV_NHB) / total_utility_NHB,
         p_walk_NHB = exp(utility_walk_NHB) / total_utility_NHB,
         p_bike_NHB = exp(utility_bike_NHB) / total_utility_NHB)
```


Now to total up number of trips by mode

```{r number HBW}
skims <- skims %>%
  mutate(n_transit_HBW = round(HBW_flow * p_transit_HBW),
         n_SOV_HBW = round(HBW_flow * p_SOV_HBW),
         n_HOV_HBW = round(HBW_flow * p_HOV_HBW),
         n_walk_HBW = round(HBW_flow * p_walk_HBW),
         n_bike_HBW = round(HBW_flow * p_bike_HBW)) %>%
  replace_na(list(n_transit_HBW = 0,
                  n_SOV_HBW = 0,
                  n_HOV_HBW = 0,
                  n_walk_HBW = 0,
                  n_bike_HBW =0)) 
```

```{r number HBO}
skims <- skims %>%
  mutate(n_transit_HBO = round(HBO_flow * p_transit_HBO),
         n_SOV_HBO = round(HBO_flow * p_SOV_HBO),
         n_HOV_HBO = round(HBO_flow * p_HOV_HBO),
         n_walk_HBO = round(HBO_flow * p_walk_HBO),
         n_bike_HBO = round(HBO_flow * p_bike_HBO)) %>%
  replace_na(list(n_transit_HBO = 0,
                  n_SOV_HBO = 0,
                  n_HOV_HBO = 0,
                  n_walk_HBO = 0,
                  n_bike_HBO =0)) 
```

```{r number NHB}
skims <- skims %>%
  mutate(n_transit_NHB = round(NHB_flow * p_transit_NHB),
         n_SOV_NHB = round(NHB_flow * p_SOV_NHB),
         n_HOV_NHB = round(NHB_flow * p_HOV_NHB),
         n_walk_NHB = round(NHB_flow * p_walk_NHB),
         n_bike_NHB = round(NHB_flow * p_bike_NHB)) %>%
  replace_na(list(n_transit_NHB = 0,
                  n_SOV_NHB = 0,
                  n_HOV_NHB = 0,
                  n_walk_NHB = 0,
                  n_bike_NHB =0)) 
```




